---
layout: post
title: 小试链上分析工具Dune
description: 在区块链上，各种公开信息错落有致地排列着，大部分是涉及金融数据的。
tags: 区块链 DeFi
---

# 小试链上分析工具Dune

> 时间：2023.4.23
>
> 作者：litianc
>
> 阅读时长：7分钟

## 前言
在区块链上，各种公开信息错落有致地排列着，大部分是涉及金融数据的。对于那些希望加入区块链行业的人而言，如何善用这些数据无疑是一个必不可少的问题。在金融分析领域中，图形展示是最为直观的工具之一，而 Dune Analytics （简称: Dune）则是链上金融数据可视化工具的典范。

## Dune的展示界面
对于关注区块链行业新闻的大多数人而言，或许在某些文章中看到过类似下面的条形或折线图。
![image](/images/posts/dune_wizard/Snipaste_2023-04-20_17-32-48.png)
这就是Dune的最常见的界面形式，用可视化图形直观展示项目的趋势，它们可以是代币的价格、DeFi的交易量、甚至穿透表面数据，识别出刷单数据。

无数这样的图形背后，是由大量且及时的链上数据、许多SQL代码和一群有趣的工程师（他们习惯被称为🧙‍♀️魔法师或👩‍🔬科学家）组成的系统。本文将从魔法师的视角，带各位读者了解一下在 Dune 上进行数据开发的流程。

## 魔法师

### 谁是魔法师

Dune 是进行区块链研究的强大工具。它可用于查询，提取和可视化以太坊区块链上的大量数据。Dune 的用户可以根据用户需求大致分为三类群体：

第一类是金融投资客或媒体人。在不少行业分析和产品分析文章中，我们看到 Dune 的可视化界面，常以NFT、DeFi或Uniswap的走势图的形式呈现，作为投资依据或用于佐证文章观点。

第二类是金主爸爸。部分的投资客或媒体人，不满足于平台中已有的数据分析结果，希望提出定制数据的需求，则可以在[平台](https://form.typeform.com/to/DtX4jqkd)上发布需求，请开发者实现其所需的功能。Dune 平台上的代码和数据是分离的，这意味着图形是动态的，已开发完成的图形，在任何时间注入最新的数据，形成最新的图形。这很大程度上提高了金主的付费意愿。

第三类用户就是那些有能力开发Dune数据的魔法师，他们不仅精通SQL语言，还了解链上的业务工作原理，进而对原始数据施法，经过多次分解、转换和组合，完成数据可视化的开发。

### 打开你的魔法书

看看如何成为一名魔法师。

#### 第一步：寻找场景
带着场景问题来研究可以帮助我们快速掌握 Dune 的技巧。作为一名对 DeFi 还未深入研究的初级魔法师，我的第一个场景便是研究 Uniswap 的工作原理。接下来，让我们一起做这道画图题：“列出Uniswap上交易量前十的交易对”。

#### 第二步：实现查询
注册完Dune账号后，在Dune首页上可以看到新建查询代码的按钮（1），在新建查询界面，左边是数据库（2），右边是查询代码编辑器（3）和输出结果（4）。
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_10-45-52.png)

我们在数据库中选“V2 Dune SQL”环境，然后在编辑器中输入以下查询语句，再点击“Run”：
``` sql
SELECT
  concat(token_pair, ' ', fee_tier) as pool_name,
  token_pair,
  fee_tier,
  lp_addr,
  SUM(CAST(amount_usd AS DOUBLE)) AS trading_volume
FROM
  query_2276042 t
WHERE
  block_time >= now() - INTERVAL '7' day
  AND CAST(amount_usd AS DOUBLE) > 0
GROUP BY
  1,
  2,
  3,
  4
ORDER BY
  trading_volume DESC
LIMIT
  10
```
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_10-54-19.png)

可以看到查询结果（上图右框）中，根据我们的代码，得出了近7天交易量排名前十的交易对，以及成交量、费率等信息，前十名依次是：“USDC-WETH 0.05%”、“USDC-USDT 0.01%”、“USDT-WETH 0.05%”...等。这样我们就知道哪些交易对在 Uniswap 上的交易量非常高，并且他们的交易手续费比一般的中心化交易所更低，当然去中心化交易的上链Gas费需要另外考虑。

更进一步，我们用柱状图和饼状图来展示每个交易对的成交额和占比，直观展示交易量的分布情况。

点击 “New visualization” 来创建图形，第一张是柱状图“Bar chart”，调整纵轴变量，参数和输出如下图：
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_11-33-56.png)
再此点击“New visualization”，用相同数据创建饼状图“Pie chart”，参数和输出如下：
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_11-41-30.png)

得到两张图形如下，从图形上可以看出，4个交易对贡献了超过85%的交易量。

完成全部设置后，点击右上角的“Save”保存代码。
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_11-45-20.png)
![image](/images/posts/dune_wizard/Snipaste_2023-04-23_11-40-25.png)

#### 第三步：Dashboard展示
在实现数据查询和可视化后，我们可以用仪表板（Dashboard）实现多个图形的聚合，形成系统性的管理界面。

除了交易量排名外，个人还关注Uniswap的其他投资指标，如提供流动性的手续费收益情况、投资UNI可量化的市盈率分析等。

这是我根据自定义的指标设计的仪表板，你也可以根据自己的想法设计仪表板，欢迎fork～
<a href="https://dune.com/litianc/uniswap-uni-valutation"><img src="/images/posts/dune_wizard/Snipaste_2023-04-23_11-58-10.png"/></a>


### 更多场景
以个人需求来看，我最初试用Dune的目的非常简单，只是好奇被区块链媒体大量引用图形工具如何使用。

随着了解到深入，发现链上的数据确实有很多可玩之处。对于某个DeFi协议的跟踪，如上文提到的Uniswap；对于一次突发事件市场影响，如硅谷银行事件和USDC；在以太坊重大升级后，用户的真实反应，这些数据分析结果加上一些基本常识，普通用户完全有能力做到领先于市场的解读，从而在投资决策中获利。

以这次以太坊上海升级为例，这是升级开启了 ETH 信标链质押ETH的取回功能。本质上说，这是一次ETH解锁释放的利空消息，但升级前网上的诸多讨论却是引导市场看好的方向发展。因此，市场的噪音特别多，验证者的真实表现变得格外重要。这次升级后，有人做了的图形监控，目前（今天是升级后一周），验证者是中性偏消极的，而市场确实比较乐观的，这样就形成了短期的套利空间。如果有兴趣可以持续关注它，以便做出理性的价值判断。

<a href="https://dune.com/hildobby/eth2-staking"><img src="/images/posts/dune_wizard/Snipaste_2023-04-23_14-18-36.png"/></a>

此外，通过 Dune 还能分析金融以外的数据，例如 Lens 的社交数据、DAO 的投票治理情况、甚至未来更多的个人数据。

## 本文没有总结

随着 DeFi Summer 带来了链上金融数据，暂时性地结束了公链竞争，并开启了链上数据分析的赛道。虽然目前仍处于赛道早期，但 Dune、Nansen、Footprint 三大龙头已逐渐形成各自的用户群体。作为一个跟紧技术潮流的区块链研究员，虽然有时会直接查询 Nansen 的图形结果，但更发自内心地喜欢 Dune 的参与感和可控性，后续还会投入时间做一些好玩的仪表板。

如果这篇文章对你有所启发，或有任何问题，欢迎留言交流。
